name: Auto Form Filler

on:
  schedule:
    # Menjalankan setiap 15 menit untuk simulasi "terus-menerus"
    - cron: '*/15 * * * *'
  workflow_dispatch:  # Memungkinkan menjalankan secara manual dari GitHub UI
  repository_dispatch:
    types: [start-script, stop-script]

# Memberikan permission yang diperlukan untuk GitHub Actions
permissions:
  contents: write
  actions: write

jobs:
  fill-form:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.8'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas selenium webdriver-manager

    - name: Install Chrome
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable

    - name: Check control file
      id: control
      run: |
        if [ -f "control.json" ]; then
          STATUS=$(jq -r '.status' control.json)
          echo "status=$STATUS" >> $GITHUB_OUTPUT
        else
          echo "status=running" >> $GITHUB_OUTPUT
        fi

    - name: Run autoFillForm script
      if: steps.control.outputs.status != 'stopped'
      env:
        FORM_URL: ${{ secrets.FORM_URL }}
      run: |
        # Jika FORM_URL tidak diset di secrets, gunakan URL default
        if [ -z "$FORM_URL" ]; then
          echo "FORM_URL not set in secrets, using default URL"
        fi
        python autoFillForm.py

    - name: Commit and push progress
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add progress.json control.json
        git commit -m "Update progress.json and control.json" || echo "No changes to commit"
        git push
      continue-on-error: true